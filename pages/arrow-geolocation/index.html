<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Geolocation</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåä</text></svg>"
    />
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script
      type="text/javascript"
      src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"
    ></script>
    <script
      type="text/javascript"
      src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"
    ></script>
    <script src="https://cdn.rawgit.com/showdownjs/showdown/2.1.0/dist/showdown.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="/styles.css" />
    <script>
      function getGPSString(vector2) {
        return `latitude:${vector2.x}; longitude:${vector2.y}`;
      }
      window.addEventListener("load", (event) => {
        const debugElem = document.querySelector("#debug");
        const avocado = document.querySelector("#avocado-entity");
        const arrow = document.querySelector("#arrow-entity");
        const camera = document.querySelector("#camera");

        camera.far = 1;

        var location = "40.47787321121269, -74.42559212972574"; //prompt("Enter Coordinates");
        let token = location.split(", ");
        const targetPos = new THREE.Vector2(token[0], token[1]);
        // avocado.setAttribute("gps-new-entity-place", getGPSString(targetPos));
        // avocado.components["gps-new-entity-place"].update();

        var geoPos = new THREE.Vector2(0, 0);

        if (navigator.geolocation) {
          const converter = new showdown.Converter();
          const lerpAvocado = false;

          // Updating the geolocation
          navigator.geolocation.watchPosition((position) => {
            geoPos = new THREE.Vector2(
              position.coords.latitude,
              position.coords.longitude
            );
          });

          let time = 0;
          const avocadoLerpTime = 10 * 1000;
          const avocadoStartPos = new THREE.Vector3(-10, 0, 0);
          const avocadoEndPos = new THREE.Vector3(10, 0, -5);
          const intervalDuration = 10;
          // Main arrow/debug info update loop
          setInterval(() => {
            const geoDist = targetPos.distanceTo(geoPos);
            const lat2meters = 111 * 1000;
            const distMeters = geoDist * lat2meters;

            const avocadoPos2D = new THREE.Vector2(
              avocado.object3D.position.x,
              avocado.object3D.position.z
            );

            if (lerpAvocado) {
              const lerpedPosition = avocadoStartPos.clone();
              lerpedPosition.lerp(
                avocadoEndPos,
                (time % avocadoLerpTime) / avocadoLerpTime
              );
              avocado.object3D.position.copy(lerpedPosition);
              time += intervalDuration;
            }

            const cameraPos2D = new THREE.Vector2(
              camera.object3D.position.x,
              camera.object3D.position.z
            );
            const direction2D = new THREE.Vector2();
            direction2D.subVectors(avocadoPos2D, cameraPos2D).normalize();
            const offset = 2;
            const arrowPos2D = new THREE.Vector2();
            arrowPos2D.addVectors(
              cameraPos2D,
              direction2D.clone().multiplyScalar(offset)
            );
            const arrowRotationRad =
              Math.atan2(direction2D.x, direction2D.y) + Math.PI;
            arrow.object3D.position.set(arrowPos2D.x, 1, arrowPos2D.y);
            arrow.object3D.rotation.set(0, arrowRotationRad, 0);

            function displayLocalPos(vector2) {
              return `x:${(vector2.x + 8285000).toFixed(
                2
              )} y: ${vector2.y.toFixed(2)} z:${(vector2.z + 4935600).toFixed(
                2
              )}`;
            }

            const debugMarkDown = `
            \n**current:** lat: ${geoPos.x} long: ${geoPos.y}
            \n**target:** lat: ${targetPos.x}; long: ${targetPos.y}
            \n**distance:** ${distMeters.toFixed(2)} meters
            \n**arrow pos:** ${displayLocalPos(arrow.object3D.position)}
            \n**camera pos:** ${displayLocalPos(camera.object3D.position)}
            \n**avocado pos:** ${displayLocalPos(avocado.object3D.position)}
            \n**arrow rot:** ${
              arrow.object3D.rotation.y
            } rad, ${THREE.MathUtils.radToDeg(arrow.object3D.rotation.y)} deg`;

            debugElem.innerHTML = converter.makeHtml(debugMarkDown);
          }, intervalDuration);
        } else {
          debugElem.innerHTML = "Geolocation is not supported.";
        }
      });
    </script>
  </head>
  <div
    style="
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 2em;
      color: white;
      background-color: rgba(0, 0, 0, 0.5);
    "
  >
    <span style="margin: 0; font-size: 0.8em" id="debug"></span>
  </div>
  <body style="margin: 0; overflow: hidden">
    <a-scene
      renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true;"
      embedded
      loading-screen="enabled: false;"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <!-- <a-camera id="camera" look-controls position="0 1.6 0"></a-camera> -->
      <a-camera
        id="camera"
        gps-new-camera="gpsMinDistance: 5"
        rotation-reader
      ></a-camera>

      <a-assets>
        <a-asset-item id="avocado" src="%BASE_URL%Avocado.glb"></a-asset-item>
        <a-asset-item id="arrow" src="%BASE_URL%arrow.glb"></a-asset-item>
      </a-assets>

      <!-- <a-entity
        id="avocado-entity"
        gltf-model="#avocado"
        scale="40 40 40"
        position="-10 0 -5"
      ></a-entity> -->

      <a-entity
        id="avocado-entity"
        gltf-model="#avocado"
        scale="40 40 40"
        gps-new-entity-place="latitude: 40.47787321121269; longitude: -74.42559212972574"
      ></a-entity>
      <a-entity
        gltf-model="#arrow"
        scale="0.25 0.25 0.25"
        id="arrow-entity"
      ></a-entity>
      <!-- <a-entity
        material="color: red"
        geometry="primitive: box"
        gps-new-entity-place="latitude: 40.47787321121269; longitude: -74.42559212972574"
        scale="5 5 5"
      ></a-entity> -->
    </a-scene>
    <a href="%BASE_URL%" class="linkButton backButton">‚¨ÖÔ∏è Back</a>
  </body>
</html>
